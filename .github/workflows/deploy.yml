name: Development Environment - Build, Push & Deploy

on:
  push:
    branches:
      - development
  pull_request:
    branches:
      - development

env:
  DOCKERHUB_USERNAME: minhazkhan
  BACKEND_IMAGE: minhazkhan/agriza-backend-1
  FRONTEND_IMAGE: minhazkhan/agriza-frontend-1

jobs:
  build-and-push-development:
    name: Build & Push Images for Development
    runs-on: ubuntu-latest
    
    outputs:
      backend-tag: ${{ steps.meta.outputs.backend-tag }}
      frontend-tag: ${{ steps.meta.outputs.frontend-tag }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Metadata
        id: meta
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=${GITHUB_SHA::8}
          
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "backend-tag=development-${TIMESTAMP}-${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "frontend-tag=development-${TIMESTAMP}-${COMMIT_SHA}" >> $GITHUB_OUTPUT
          
          echo "ğŸš€ Building for DEVELOPMENT environment"
          echo "ğŸ“¦ Backend: ${{ env.BACKEND_IMAGE }}"
          echo "ğŸ“¦ Frontend: ${{ env.FRONTEND_IMAGE }}"

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:development
            ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.backend-tag }}
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:development
            ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.frontend-tag }}
            ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Success Notification
        run: |
          echo "ğŸ‰ Development images built successfully!"
          echo "ğŸ”¹ Backend: ${{ env.BACKEND_IMAGE }}:development"
          echo "ğŸ”¹ Frontend: ${{ env.FRONTEND_IMAGE }}:development"
          echo "ğŸ“ Commit: ${{ github.sha }}"

  deploy-to-development:
    name: Deploy to Development Environment
    needs: build-and-push-development
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy Containers
        run: |
          echo "ğŸš€ DEPLOYING TO DEVELOPMENT ENVIRONMENT"
          echo "======================================"
          echo "ğŸ“¦ Using repositories:"
          echo "   Backend:  ${{ env.BACKEND_IMAGE }}"
          echo "   Frontend: ${{ env.FRONTEND_IMAGE }}"
          
          # Stop and remove existing containers (prevents overlap)
          echo "ğŸ§¹ Cleaning up existing containers..."
          docker stop agriza-backend-dev agriza-frontend-dev 2>/dev/null || true
          docker rm agriza-backend-dev agriza-frontend-dev 2>/dev/null || true
          
          # Remove old images to prevent overlap
          docker rmi ${{ env.BACKEND_IMAGE }}:development ${{ env.FRONTEND_IMAGE }}:development 2>/dev/null || true
          
          # Create network
          docker network create agriza-dev-network 2>/dev/null || true
          
          # Pull and deploy new images
          echo "ğŸ“¥ Pulling latest development images..."
          docker pull ${{ env.BACKEND_IMAGE }}:development
          docker pull ${{ env.FRONTEND_IMAGE }}:development
          
          # Deploy backend
          echo "ğŸƒ Deploying backend container..."
          docker run -d \
            --name agriza-backend-dev \
            --network agriza-dev-network \
            --network-alias backend \
            -p 5001:5000 \
            -e NODE_ENV=development \
            -e PORT=5000 \
            -e JWT_SECRET_KEY=dev-jwt-secret-key \
            -e JWT_SECRET=dev-jwt-secret-key \
            -e SECRET_KEY=dev-jwt-secret-key \
            -e SECRET=dev-jwt-secret-key \
            -e SESSION_SECRET=dev-session-secret \
            -e SMS_URL=https://api.textlocal.in/send/ \
            -e SMS_API_KEY=dummy-sms-key \
            -e SMS_USERNAME=dummy-user \
            -e SMS_FROM=AGRIZA \
            -e LOG_LEVEL=debug \
            --restart unless-stopped \
            ${{ env.BACKEND_IMAGE }}:development
          
          # Deploy frontend
          echo "ğŸƒ Deploying frontend container..."
          docker run -d \
            --name agriza-frontend-dev \
            --network agriza-dev-network \
            -p 3001:3000 \
            -e REACT_APP_ENV=development \
            -e REACT_APP_API_URL=http://localhost:5001 \
            --restart unless-stopped \
            ${{ env.FRONTEND_IMAGE }}:development

      - name: Health Check & Verification
        run: |
          echo "ğŸ” Performing health checks..."
          
          # Wait for services
          echo "â³ Waiting for services to start..."
          sleep 45
          
          # Check containers
          echo "ğŸ“‹ Container Status:"
          docker ps --filter name=agriza-backend-dev --filter name=agriza-frontend-dev
          
          # Backend health check
          echo "ğŸ¥ Backend Health Check:"
          BACKEND_STATUS="âŒ Unhealthy"
          for i in {1..5}; do
            if curl -f -s http://localhost:5001/api/ > /dev/null; then
              echo "âœ… Backend health check passed (attempt $i)"
              BACKEND_STATUS="âœ… Healthy"
              break
            else
              echo "â³ Backend health check failed, retrying... (attempt $i/5)"
              sleep 10
            fi
          done
          
          # Frontend health check
          echo "ğŸ¥ Frontend Health Check:"
          FRONTEND_STATUS="âŒ Unhealthy"
          for i in {1..5}; do
            if curl -f -s http://localhost:3001 > /dev/null; then
              echo "âœ… Frontend health check passed (attempt $i)"
              FRONTEND_STATUS="âœ… Healthy"
              break
            else
              echo "â³ Frontend health check failed, retrying... (attempt $i/5)"
              sleep 10
            fi
          done
          
          echo ""
          echo "ğŸ“Š FINAL HEALTH STATUS:"
          echo "Backend: $BACKEND_STATUS"
          echo "Frontend: $FRONTEND_STATUS"

      - name: Deployment Success & Rollback Instructions
        run: |
          echo ""
          echo "ğŸ‰ DEVELOPMENT DEPLOYMENT COMPLETED!"
          echo "==================================="
          echo ""
          echo "ğŸ“ Application Access URLs:"
          echo "   ğŸŒ Frontend:      http://localhost:3001"
          echo "   ğŸ”§ Backend:       http://localhost:5001"
          echo "   ğŸ©º Health Check:  http://localhost:5001/health"
          echo "   ğŸ“¡ API Endpoint:  http://localhost:5001/api/"
          echo ""
          echo "ğŸ“¦ Docker Hub Repositories:"
          echo "   ğŸ”§ Backend:  https://hub.docker.com/r/${{ env.BACKEND_IMAGE }}"
          echo "   ğŸŒ Frontend: https://hub.docker.com/r/${{ env.FRONTEND_IMAGE }}"
          echo ""
          echo "ğŸ“‹ Deployment Details:"
          echo "   ğŸ“¦ Backend:  ${{ env.BACKEND_IMAGE }}:development"
          echo "   ğŸ“¦ Frontend: ${{ env.FRONTEND_IMAGE }}:development"
          echo "   ğŸ“ Commit:   ${{ github.sha }}"
          echo "   ğŸ‘¤ By:       ${{ github.actor }}"
          echo "   ğŸ•’ At:       $(date)"
          echo ""
          echo "ğŸ”„ ROLLBACK INSTRUCTIONS:"
          echo "========================="
          echo "1ï¸âƒ£ Find problematic commit: git log --oneline development"
          echo "2ï¸âƒ£ Revert the commit: git revert <commit-hash>"
          echo "3ï¸âƒ£ Push to trigger redeployment: git push origin development"
          echo "4ï¸âƒ£ GitHub Actions will automatically rebuild and redeploy"

      - name: Generate Deployment Summary
        run: |
          echo "## ğŸš€ Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | URL | Docker Repository |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-----|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | âœ… Deployed | http://localhost:5001 | \`${{ env.BACKEND_IMAGE }}:development\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | âœ… Deployed | http://localhost:3001 | \`${{ env.FRONTEND_IMAGE }}:development\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‘¤ **Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ•’ **Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY
