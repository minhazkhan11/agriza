name: Development Environment - Build, Push & Deploy

on:
  push:
    branches:
      - development

env:
  DOCKERHUB_USERNAME: minhazkhan
  BACKEND_IMAGE: minhazkhan/agriza-backend-1
  FRONTEND_IMAGE: minhazkhan/agriza-frontend-1

jobs:
  build-and-push:
    name: Build & Push Development Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:development
            ${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:development
            ${{ env.FRONTEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-to-development:
    name: Deploy to Development Environment
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy Containers
        run: |
          echo "üöÄ DEPLOYING TO DEVELOPMENT ENVIRONMENT"
          
          # Clean up existing containers (prevents overlap)
          docker stop agriza-backend-dev agriza-frontend-dev 2>/dev/null || true
          docker rm agriza-backend-dev agriza-frontend-dev 2>/dev/null || true
          docker network create agriza-dev-network 2>/dev/null || true
          
          # Pull and deploy latest images
          docker pull ${{ env.BACKEND_IMAGE }}:development
          docker pull ${{ env.FRONTEND_IMAGE }}:development
          
          # Deploy backend
          docker run -d \
            --name agriza-backend-dev \
            --network agriza-dev-network \
            --network-alias backend \
            -p 5001:5000 \
            -e NODE_ENV=development \
            -e PORT=5000 \
            --restart unless-stopped \
            ${{ env.BACKEND_IMAGE }}:development
          
          # Deploy frontend
          docker run -d \
            --name agriza-frontend-dev \
            --network agriza-dev-network \
            -p 3001:3000 \
            --restart unless-stopped \
            ${{ env.FRONTEND_IMAGE }}:development

      - name: Health Check
        run: |
          echo "üîç Running health checks..."
          sleep 30
          docker ps --filter name=agriza-backend-dev --filter name=agriza-frontend-dev

      - name: Deployment Success
        run: |
          echo "üéâ DEVELOPMENT DEPLOYMENT COMPLETED!"
          echo "üìç Frontend: http://localhost:3001"
          echo "üìç Backend:  http://localhost:5001"
          echo "üîÑ ROLLBACK: git revert <commit> && git push origin development"
